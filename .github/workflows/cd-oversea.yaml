name: CD Oversea

on:
  release:
    types:
      - released
      - prereleased
  # 添加 push tags 触发器
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-upload-cli-artifact:
    strategy:
      matrix:
        include:
          - arch: amd64
            os: linux
          - arch: amd64
            os: darwin
          - arch: arm64
            os: linux
          - arch: arm64
            os: darwin
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GCP_DOWNLOAD_BUCKET_NAME: ${{ vars.GCP_DOWNLOAD_BUCKET_NAME }}
    steps:
      - name: Determine version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      - name: Check if version is semantic
        run: echo "$TAG_NAME" | grep -q -E '^v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-((0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$'
      - name: Check if version is release or beta
        run: |
          if echo "$TAG_NAME" | grep -q -E '^v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)$'; then
            echo "IS_RELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_RELEASE=false" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up go
        uses: actions/setup-go@v4

      - name: Build cocli (oversea endpoints)
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "$TAG_NAME" ]; then
            git checkout "$TAG_NAME"
          fi
          CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} make build-binary-oversea
          cp bin/cocli cocli
          cp bin/cocli bin/cocli-oversea-${{ matrix.os }}-${{ matrix.arch }}

      - name: Upload release artifact (oversea)
        if: github.event_name != 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          files: bin/cocli-oversea-${{ matrix.os }}-${{ matrix.arch }}

      - name: Install gzip
        run: sudo apt-get update && sudo apt-get install -y gzip

      - name: Build release metadata files
        if: env.IS_RELEASE == 'true'
        run: |
          SHA256SUM=$(sha256sum cocli | awk '{print $1}' | xxd -r -p | base64)
          echo "{\"Version\": \"$TAG_NAME\", \"Sha256\": \"$SHA256SUM\"}" > ${{ matrix.os }}-${{ matrix.arch }}.json

      - name: gzip cocli
        run: gzip -f cocli

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_DOWNLOAD_BUCKET_UPLOADER_CREDENTIALS }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload cocli to GCS corresponding version
        run: |
          gsutil cp cocli.gz gs://$GCP_DOWNLOAD_BUCKET_NAME/cocli/$TAG_NAME/${{ matrix.os }}-${{ matrix.arch }}.gz

      - name: Upload cocli to GCS latest
        if: env.IS_RELEASE == 'true'
        run: |
          gsutil cp cocli.gz gs://$GCP_DOWNLOAD_BUCKET_NAME/cocli/latest/${{ matrix.os }}-${{ matrix.arch }}.gz
          gsutil cp ${{ matrix.os }}-${{ matrix.arch }}.json gs://$GCP_DOWNLOAD_BUCKET_NAME/cocli/${{ matrix.os }}-${{ matrix.arch }}.json
